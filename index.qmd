---
params:
  target_study: "ryegrass"
title: "Bio-Efficacy Dose-Response Report: `r stringr::str_to_title(params$target_study)`"
author: "Keith Post"
date: last-modified
format: 
  html:
    theme: cosmo
    toc: true
    code-fold: true
    self-contained: true
execute:
  echo: false
  warning: false
  message: false
---

```{r}
#| label: setup
#| include: false

# Import libraries
library(here)
library(tidyverse)

# Set target study
target_study <- params$target_study

# Create fps
fp_audit_plot <- paste0("output/plots/", target_study, "_audit_plot.png")

fp_final_plot <- paste0("output/plots/", target_study, "_final_curve.png")

df_stats <- here("output", "tables", paste0(target_study, "_summary_stats.csv")) %>%
  read.csv()

my_suitcase <- here("output", "models", paste0(target_study, "_full_suitcase.rds")) %>%
                      readRDS()

# Define objects
snr <- round(my_suitcase$snr, 2)
dose_ratio <- round(my_suitcase$dose_ratio, 2)
n_outliers <- length(my_suitcase$outlier_indices)
at_plateau <- my_suitcase$at_plateau

model_name <- my_suitcase$modeling$winner_name
model_label <- my_suitcase$modeling$winner_label
model_rationale <- my_suitcase$modeling$rationale
model_table <- my_suitcase$modeling$table


```

## Data Quality & Suitability Audit
### Trial Robustness
* **Signal-to-Noise Ratio (SNR):** The analysis of the dataset returned an SNR of `r snr`, which suggests `r if(snr>=5){
"robust treatment effect with minimal background interference."
} else if(snr >= 3 & snr < 5){
"clear dose-response signal; suitable for reliable parameter estimation."
} else if(snr >= 1.5 & snr < 3){
"a clear detectable signal, but high variance may increase $ED_{50}$ uncertainty."
} else{
"a signal indistinguishable from noise. Modeling results should be considered exploratory."
}`

* **Dose Coverage:** The `r target_study` dataset has a dose ratio of `r dose_ratio`. This value indicates `r if(dose_ratio >= 50){
"exceptional dose distribution across multiple orders of magnitude."
} else if(dose_ratio >= 10 & dose_ratio < 50){
"standard dose coverage for robust non-linear parameter estimation."
} else if(dose_ratio >= 5 & dose_ratio < 10){
"risk of 'fragmented' curves; the model may struggle to fix the slope accurately."
} else{
"insufficient range; the resulting model may be under-determined."
}`


### Data Integrity
* **Outlier Count:** `r if(n_outliers==0){
paste("No outliers were found in the", target_study,"dataset.")
} else if(n_outliers==1){
paste("One outlier was found in the", target_study, "dataset.")
} else{
paste(n_outliers, "outliers were found in the", target_study, "dataset.")
}`

* **Plateau Status:** `r if(at_plateau){
paste("The dose range successfully captured the terminal response plateau, providing a high degree of confidence in the upper-limit estimation.")
}else{
"Warning: The biological response did not reach a stable plateau within the tested dose range. Estimations of maximum effect and relative potency ($ED_{50}$) may involve mathematical extrapolation."
}`

### Visual Audit Summary
The following figure illustrates the distribution of raw data points (replicates) relative to the calculated dose-means. This visualization allows for a direct assessment of the 'Signal' (the trend of the blue line) against the 'Noise' (the vertical spread of the grey points and error bars).

`r if(n_outliers > 0){
"Any points highlighted with **red X's** represent identified outliers that were evaluated during the quality control sweep."}`

![](`r fp_audit_plot`){fig-align="center" width="80%"}



## Dose-Response Analysis & Parameter Estimation
### Model Selection
`r if(model_name=="Null") { 
paste("Evaluation of the dataset indicates", paste0("**", model_label, "**"), ". ", model_rationale) 
} else{ 
paste("The biological response was characterized using a", paste0("**", model_label, "**"), "function. This selection was based on the following criteria:", model_rationale) 
}`


### The Final Curve
![](`r fp_final_plot`){fig-align="center" width="80%`}


## Primary Potency Parameters
`r if(model_name=="Null") {
"No potency parameters could be calculated."
} else{
paste("The table below summarizes the statistical output and potency estimates for the", target_study, "dataset.")
}`

`r if(model_name != "Null") {model_table}`



